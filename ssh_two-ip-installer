#!/bin/bash

# ================== COLORS ==================
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m'

clear

echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ğŸš€  AliFlash SSH Two IP Auto Installer  ğŸš€${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# ================== UPDATE ==================
echo -e "${BLUE}ğŸ“¦ Updating system...${NC}"
sudo apt update -y >/dev/null 2>&1
echo -e "${GREEN}âœ” System updated${NC}"
echo ""

# ================== INPUT ==================
echo -e "${YELLOW}ğŸ”§ Enter Configuration Details:${NC}"
echo -ne "${WHITE}ğŸŒ Primary IP: ${NC}"
read PRIMARY_IP

echo -ne "${WHITE}ğŸŒ Secondary IP: ${NC}"
read SECONDARY_IP

echo -ne "${WHITE}ğŸ” SSH Port: ${NC}"
read SSH_PORT

echo -ne "${WHITE}ğŸ“¡ Local Port: ${NC}"
read PORT_LOCAL

echo -ne "${WHITE}ğŸ“¡ Remote Port: ${NC}"
read PORT_REMOTE

echo -ne "${WHITE}ğŸ”‘ Outside Server Root Password: ${NC}"
read -s SERVER_PASS
echo ""
echo ""

# ================== SSH CONFIG ==================
echo -e "${BLUE}âš™ï¸  Configuring SSH KeepAlive...${NC}"

cat >> /etc/ssh/sshd_config <<EOF

ClientAliveInterval 60
ClientAliveCountMax 3
TCPKeepAlive yes
EOF

systemctl restart ssh
echo -e "${GREEN}âœ” SSH Config Updated${NC}"

# ================== LIMITS ==================
echo -e "${BLUE}ğŸ“ˆ Increasing File Limits...${NC}"

cat >> /etc/security/limits.conf <<EOF
* soft nofile 1048576
* hard nofile 1048576
root soft nofile 1048576
root hard nofile 1048576
EOF

echo "DefaultLimitNOFILE=1048576" >> /etc/systemd/system.conf
echo "DefaultLimitNOFILE=1048576" >> /etc/systemd/user.conf

mkdir -p /etc/systemd/system/ssh.service.d

cat > /etc/systemd/system/ssh.service.d/override.conf <<EOF
[Service]
LimitNOFILE=1048576
EOF

echo -e "${GREEN}âœ” Limits Configured${NC}"

# ================== SSH KEY ==================
echo -e "${BLUE}ğŸ” Generating SSH Key...${NC}"
yes "" | ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa >/dev/null 2>&1

apt install -y sshpass >/dev/null 2>&1

echo -e "${BLUE}ğŸ“¡ Sending SSH Key to Primary Server...${NC}"
sshpass -p "$SERVER_PASS" ssh-copy-id -o StrictHostKeyChecking=no -p ${SSH_PORT} root@${PRIMARY_IP} >/dev/null 2>&1

echo -e "${GREEN}âœ” SSH Key Installed${NC}"

# ================== TWO_IP SCRIPT ==================
echo -e "${BLUE}ğŸ“ Creating Tunnel Script...${NC}"

cat > /usr/local/bin/two_ip <<EOF
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"

connect_ssh() {
    IP=\$1
    echo "Trying \$IP ..."
    
    /usr/bin/ssh \\
    -o ConnectTimeout=10 \\
    -o ServerAliveInterval=10 \\
    -o ServerAliveCountMax=2 \\
    -o TCPKeepAlive=no \\
    -o ExitOnForwardFailure=yes \\
    -N -L 0.0.0.0:${PORT_LOCAL}:127.0.0.1:${PORT_REMOTE} \\
    -p ${SSH_PORT} root@\${IP}
}

while true; do
    if [ -f "\$CONFIG_FILE" ]; then
        source "\$CONFIG_FILE"
    else
        echo "Config file not found!"
        sleep 10
        continue
    fi

    connect_ssh \$PRIMARY_IP || connect_ssh \$SECONDARY_IP
    echo "Tunnel disconnected. Restarting..."
    sleep 2
done
EOF

chmod +x /usr/local/bin/two_ip
echo -e "${GREEN}âœ” Tunnel Script Created${NC}"

# ================== CONFIG FILE ==================
echo -e "${BLUE}ğŸ“„ Creating Config File...${NC}"

cat > /etc/two_ip.conf <<EOF
PRIMARY_IP="${PRIMARY_IP}"
SECONDARY_IP="${SECONDARY_IP}"
PORT_LOCAL="${PORT_LOCAL}"
PORT_REMOTE="${PORT_REMOTE}"
SSH_PORT="${SSH_PORT}"
MAX_RETRY=2
EOF

chmod 600 /etc/two_ip.conf
chown root:root /etc/two_ip.conf

echo -e "${GREEN}âœ” Config File Created${NC}"

# ================== SERVICE ==================
echo -e "${BLUE}ğŸ”§ Creating systemd Service...${NC}"

cat > /etc/systemd/system/autossh-iran.service <<EOF
[Unit]
Description=SSH Tunnel Iran Two IP Failover
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/two_ip
Restart=always
RestartSec=3
TimeoutStopSec=5
KillMode=mixed
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reexec
systemctl daemon-reload
systemctl enable autossh-iran >/dev/null 2>&1
systemctl start autossh-iran

echo ""
echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ğŸ‰ INSTALLATION COMPLETED SUCCESSFULLY ğŸ‰${NC}"
echo -e "${CYAN}âœ” SSH KeepAlive Enabled${NC}"
echo -e "${CYAN}âœ” System Limits Increased${NC}"
echo -e "${CYAN}âœ” SSH Key Installed${NC}"
echo -e "${CYAN}âœ” Tunnel Service Running${NC}"
echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}ğŸ“Œ Check status:${NC} systemctl status autossh-iran"
