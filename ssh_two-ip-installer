#!/bin/bash

# ================= COLORS =================
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
NC='\033[0m'

CONFIG_FILE="/etc/two_ip.conf"
LOG_FILE="/var/log/two_ip.log"

clear
echo -e "${CYAN}==============================================${NC}"
echo -e "${GREEN}        ðŸš€ SSH-TWO Professional Manager ðŸš€${NC}"
echo -e "${CYAN}==============================================${NC}"

# ================= FUNCTIONS =================

check_root() {
if [[ $EUID -ne 0 ]]; then
 echo -e "${RED}Run as root${NC}"
 exit 1
fi
}

install_script() {

echo -e "${BLUE}Updating system...${NC}"
apt update -y >/dev/null 2>&1

echo -e "${YELLOW}Enter Config:${NC}"
read -p "Primary IP: " PRIMARY_IP
read -p "Secondary IP: " SECONDARY_IP
read -p "SSH Port: " SSH_PORT
read -p "Local Port: " PORT_LOCAL
read -p "Remote Port: " PORT_REMOTE
read -s -p "Root Password (Primary): " SERVER_PASS
echo ""

# SSH KeepAlive only if not exist
grep -q "ClientAliveInterval" /etc/ssh/sshd_config || cat >> /etc/ssh/sshd_config <<EOF

ClientAliveInterval 60
ClientAliveCountMax 3
TCPKeepAlive yes
EOF

systemctl restart ssh

# SSH Key check
if [ ! -f ~/.ssh/id_rsa ]; then
echo -e "${BLUE}Generating SSH Key...${NC}"
ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa
fi

apt install sshpass -y >/dev/null 2>&1

echo -e "${BLUE}Sending key...${NC}"
sshpass -p "$SERVER_PASS" ssh-copy-id -o StrictHostKeyChecking=no -p ${SSH_PORT} root@${PRIMARY_IP}

# ================= SCRIPT =================

cat > /usr/local/bin/two_ip <<'EOF'
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"
LOG_FILE="/var/log/two_ip.log"

log(){
echo "$(date '+%F %T') | $1" >> $LOG_FILE
}

check_ip(){
ping -c1 -W2 $1 >/dev/null 2>&1
}

connect(){
IP=$1

log "Connecting to $IP"

ssh \
-o ConnectTimeout=10 \
-o ServerAliveInterval=15 \
-o ServerAliveCountMax=2 \
-o ExitOnForwardFailure=yes \
-N -L 0.0.0.0:${PORT_LOCAL}:127.0.0.1:${PORT_REMOTE} \
-p ${SSH_PORT} root@${IP}
}

while true
do

source $CONFIG_FILE

if check_ip $PRIMARY_IP; then
log "Primary OK"
connect $PRIMARY_IP
else
log "Primary DOWN"
fi

log "Switching to secondary"

if check_ip $SECONDARY_IP; then
connect $SECONDARY_IP
else
log "Secondary DOWN"
sleep 5
fi

sleep 2

done
EOF

chmod +x /usr/local/bin/two_ip

# ================= CONFIG =================

cat > $CONFIG_FILE <<EOF
PRIMARY_IP="${PRIMARY_IP}"
SECONDARY_IP="${SECONDARY_IP}"
PORT_LOCAL="${PORT_LOCAL}"
PORT_REMOTE="${PORT_REMOTE}"
SSH_PORT="${SSH_PORT}"
EOF

chmod 600 $CONFIG_FILE

# ================= SERVICE =================

cat > /etc/systemd/system/twoip.service <<EOF
[Unit]
Description=SSH Tunnel Two IP Failover
After=network-online.target

[Service]
ExecStart=/usr/local/bin/two_ip
Restart=always
RestartSec=3
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable twoip
systemctl restart twoip

echo -e "${GREEN}INSTALL DONE${NC}"
}

restart_tunnel(){
systemctl restart twoip
echo -e "${GREEN}Restarted${NC}"
}

stop_tunnel(){
systemctl stop twoip
echo -e "${RED}Stopped${NC}"
}

status_tunnel(){
systemctl status twoip --no-pager
}

# ================= MENU =================

check_root

while true
do

echo ""
echo -e "${YELLOW}============== MENU ==============${NC}"
echo "1 - Install"
echo "2 - Restart Tunnel"
echo "3 - Stop Tunnel"
echo "4 - Status"
echo "5 - Exit"
read -p "Choose: " CHOICE

case $CHOICE in
1) install_script ;;
2) restart_tunnel ;;
3) stop_tunnel ;;
4) status_tunnel ;;
5) exit ;;
*) echo "Wrong option" ;;
esac

done
