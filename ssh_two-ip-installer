#!/bin/bash

# ================= COLORS =================
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m'

CONFIG_FILE="/etc/two_ip.conf"

# ================= CLEAR & LOGO =================
clear
echo -e "${CYAN}==============================================${NC}"
echo -e "${GREEN}        ðŸš€ SSH-TWO Installer & Manager ðŸš€${NC}"
echo -e "${CYAN}==============================================${NC}"
echo ""

# ================= FUNCTIONS =================

install_script() {
    echo -e "${BLUE}ðŸ“¦ Updating system...${NC}"
    sudo apt update -y >/dev/null 2>&1
    echo -e "${GREEN}âœ” System updated${NC}\n"

    # ================== INPUT ==================
    echo -e "${YELLOW}ðŸ”§ Enter Configuration Details:${NC}"
    echo -ne "${WHITE}ðŸŒ Primary IP: ${NC}"
    read PRIMARY_IP

    echo -ne "${WHITE}ðŸŒ Secondary IP: ${NC}"
    read SECONDARY_IP

    echo -ne "${WHITE}ðŸ” SSH Port: ${NC}"
    read SSH_PORT

    echo -ne "${WHITE}ðŸ“¡ Local Port: ${NC}"
    read PORT_LOCAL

    echo -ne "${WHITE}ðŸ“¡ Remote Port: ${NC}"
    read PORT_REMOTE

    echo -ne "${MAGENTA}ðŸ”‘ Password for Outside Server (root): ${NC}"
    read -s SERVER_PASS
    echo ""

    # ================= SSH CONFIG =================
    echo -e "${BLUE}âš™ï¸  Configuring SSH KeepAlive...${NC}"
    sudo bash -c "cat >> /etc/ssh/sshd_config" <<EOF

ClientAliveInterval 60
ClientAliveCountMax 3
TCPKeepAlive yes
EOF
    sudo systemctl restart ssh
    echo -e "${GREEN}âœ” SSH Config Updated${NC}"

    # ================= LIMITS =================
    echo -e "${BLUE}ðŸ“ˆ Increasing File Limits...${NC}"
    sudo bash -c "cat >> /etc/security/limits.conf" <<EOF
* soft nofile 1048576
* hard nofile 1048576
root soft nofile 1048576
root hard nofile 1048576
EOF

    echo "DefaultLimitNOFILE=1048576" | sudo tee -a /etc/systemd/system.conf >/dev/null
    echo "DefaultLimitNOFILE=1048576" | sudo tee -a /etc/systemd/user.conf >/dev/null

    sudo mkdir -p /etc/systemd/system/ssh.service.d
    sudo bash -c "cat > /etc/systemd/system/ssh.service.d/override.conf" <<EOF
[Service]
LimitNOFILE=1048576
EOF

    echo -e "${GREEN}âœ” Limits Configured${NC}"

    # ================= SSH KEY =================
    echo -e "${BLUE}ðŸ” Generating SSH Key...${NC}"
    yes "" | ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa >/dev/null 2>&1
    sudo apt install -y sshpass >/dev/null 2>&1

    echo -e "${BLUE}ðŸ“¡ Sending SSH Key to Primary Server...${NC}"
    sshpass -p "$SERVER_PASS" ssh-copy-id -o StrictHostKeyChecking=no -p ${SSH_PORT} root@${PRIMARY_IP} >/dev/null 2>&1
    echo -e "${GREEN}âœ” SSH Key Installed${NC}"

    # ================= TWO_IP SCRIPT =================
    echo -e "${BLUE}ðŸ“ Creating Tunnel Script...${NC}"
    sudo bash -c "cat > /usr/local/bin/two_ip" <<EOF
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"

connect_ssh() {
    IP=\$1
    echo "Trying \$IP ..."
    /usr/bin/ssh -o ConnectTimeout=10 -o ServerAliveInterval=10 -o ServerAliveCountMax=2 -o TCPKeepAlive=no -o ExitOnForwardFailure=yes -N -L 0.0.0.0:${PORT_LOCAL}:127.0.0.1:${PORT_REMOTE} -p ${SSH_PORT} root@\${IP}
}

while true; do
    if [ -f "\$CONFIG_FILE" ]; then
        source "\$CONFIG_FILE"
    else
        echo "Config file not found!"
        sleep 10
        continue
    fi
    connect_ssh \$PRIMARY_IP || connect_ssh \$SECONDARY_IP
    echo "Tunnel disconnected. Restarting..."
    sleep 2
done
EOF

    sudo chmod +x /usr/local/bin/two_ip
    echo -e "${GREEN}âœ” Tunnel Script Created${NC}"

    # ================= CONFIG FILE =================
    echo -e "${BLUE}ðŸ“„ Creating Config File...${NC}"
    sudo bash -c "cat > /etc/two_ip.conf" <<EOF
PRIMARY_IP="${PRIMARY_IP}"
SECONDARY_IP="${SECONDARY_IP}"
PORT_LOCAL="${PORT_LOCAL}"
PORT_REMOTE="${PORT_REMOTE}"
SSH_PORT="${SSH_PORT}"
MAX_RETRY=2
EOF
    sudo chmod 600 /etc/two_ip.conf
    sudo chown root:root /etc/two_ip.conf
    echo -e "${GREEN}âœ” Config File Created${NC}"

    # ================= SERVICE =================
    echo -e "${BLUE}ðŸ”§ Creating systemd Service...${NC}"
    sudo bash -c "cat > /etc/systemd/system/autossh-iran.service" <<EOF
[Unit]
Description=SSH Tunnel Iran Two IP Failover
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/two_ip
Restart=always
RestartSec=3
TimeoutStopSec=5
KillMode=mixed
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload
    sudo systemctl enable autossh-iran >/dev/null 2>&1
    sudo systemctl start autossh-iran

    echo -e "${GREEN}âœ” Installation Completed! Tunnel Service Running${NC}"
}

uninstall_script() {
    echo -e "${RED}ðŸ—‘ï¸  Running Uninstall...${NC}"
    read -p "âš ï¸  Are you sure? [y/N]: " CONFIRM
    if [[ "$CONFIRM" != "y" && "$CONFIRM" != "Y" ]]; then
        echo -e "${GREEN}âœ… Uninstall cancelled.${NC}"
        return
    fi

    echo -e "${BLUE}ðŸ›‘ Stopping services...${NC}"
    sudo systemctl stop autossh-iran 2>/dev/null
    sudo systemctl disable autossh-iran 2>/dev/null
    sudo systemctl daemon-reload

    echo -e "${BLUE}ðŸ—‘ï¸ Removing files...${NC}"
    sudo rm -f /usr/local/bin/two_ip
    sudo rm -f /etc/two_ip.conf
    sudo rm -f /etc/systemd/system/autossh-iran.service
    sudo rm -rf /etc/systemd/system/ssh.service.d/override.conf

    echo -e "${BLUE}ðŸ§¹ Cleaning system limits...${NC}"
    sudo sed -i '/\* soft nofile 1048576/d' /etc/security/limits.conf
    sudo sed -i '/\* hard nofile 1048576/d' /etc/security/limits.conf
    sudo sed -i '/root soft nofile 1048576/d' /etc/security/limits.conf
    sudo sed -i '/root hard nofile 1048576/d' /etc/security/limits.conf

    sudo sed -i '/DefaultLimitNOFILE=1048576/d' /etc/systemd/system.conf
    sudo sed -i '/DefaultLimitNOFILE=1048576/d' /etc/systemd/user.conf

    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload

    echo -e "${GREEN}âœ” Uninstall Completed. All files and services removed.${NC}"
}

edit_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}Config file not found!${NC}"
        sleep 2
        return
    fi
    echo -e "${CYAN}Press Enter to keep the current value${NC}"
    source $CONFIG_FILE

    read -p "Primary IP [$PRIMARY_IP]: " TMP
    PRIMARY_IP=${TMP:-$PRIMARY_IP}

    read -p "Secondary IP [$SECONDARY_IP]: " TMP
    SECONDARY_IP=${TMP:-$SECONDARY_IP}

    read -p "SSH Port [$SSH_PORT]: " TMP
    SSH_PORT=${TMP:-$SSH_PORT}

    read -p "Local Port [$PORT_LOCAL]: " TMP
    PORT_LOCAL=${TMP:-$PORT_LOCAL}

    read -p "Remote Port [$PORT_REMOTE]: " TMP
    PORT_REMOTE=${TMP:-$PORT_REMOTE}

    sudo bash -c "cat > $CONFIG_FILE" <<EOF
PRIMARY_IP="$PRIMARY_IP"
SECONDARY_IP="$SECONDARY_IP"
PORT_LOCAL="$PORT_LOCAL"
PORT_REMOTE="$PORT_REMOTE"
SSH_PORT="$SSH_PORT"
MAX_RETRY=2
EOF
    echo -e "${GREEN}âœ” Config updated successfully!${NC}"
}

restart_tunnel() {
    echo -e "${BLUE}ðŸ”„ Restarting SSH Tunnel...${NC}"
    sudo systemctl restart autossh-iran
    echo -e "${GREEN}âœ” Tunnel Restarted${NC}"
}

# ================= MENU =================
while true; do
    echo -e "${YELLOW}================ Menu ================${NC}"
    echo -e "${BLUE}1.${NC} Installation"
    echo -e "${MAGENTA}2.${NC} Edit Config File (/etc/two_ip.conf)"
    echo -e "${CYAN}3.${NC} Restart SSH-Tunnel"
    echo -e "${RED}4.${NC} Uninstall SSH-TWO"
    echo -e "${GREEN}5.${NC} Exit"
    echo -ne "${WHITE}Choose an option: ${NC}"
    read CHOICE

    case $CHOICE in
        1) install_script ;;
        2) edit_config ;;
        3) restart_tunnel ;;
        4) uninstall_script ;;
        5) echo -e "${GREEN}ðŸ‘‹ Exiting...${NC}"; exit 0 ;;
        *) echo -e "${RED}Invalid option. Try again.${NC}" ;;
    esac
done
