#!/bin/bash

# ================= COLORS =================
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m'

CONFIG_FILE="/etc/two_ip.conf"

# ================= CLEAR & LOGO =================
clear
echo -e "${CYAN}==============================================${NC}"
echo -e "${GREEN}        ðŸš€ SSH-TWO Installer & Manager ðŸš€${NC}"
echo -e "${CYAN}==============================================${NC}"
echo ""

# ================= FUNCTIONS =================

install_script() {

    echo -e "${BLUE}ðŸ“¦ Updating system...${NC}"
    sudo apt update -y >/dev/null 2>&1
    echo -e "${GREEN}âœ” System updated${NC}\n"

    echo -e "${YELLOW}ðŸ”§ Enter Configuration Details:${NC}"
    read -p "ðŸŒ Primary IP: " PRIMARY_IP
    read -p "ðŸŒ Secondary IP: " SECONDARY_IP
    read -p "ðŸ” SSH Port: " SSH_PORT
    read -p "ðŸ“¡ Local Port: " PORT_LOCAL
    read -p "ðŸ“¡ Remote Port: " PORT_REMOTE
    read -s -p "ðŸ”‘ Password for Outside Server (root): " SERVER_PASS
    echo ""

    # ================= SSH KeepAlive =================
    echo -e "${BLUE}âš™ï¸  Configuring SSH KeepAlive...${NC}"
    sudo bash -c "cat >> /etc/ssh/sshd_config" <<EOF

ClientAliveInterval 60
ClientAliveCountMax 3
TCPKeepAlive yes
EOF
    sudo systemctl restart ssh
    echo -e "${GREEN}âœ” SSH Config Updated${NC}"

    # ================= SSH KEY =================
    echo -e "${BLUE}ðŸ” Generating SSH Key...${NC}"
    yes "" | ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa >/dev/null 2>&1
    sudo apt install -y sshpass >/dev/null 2>&1

    echo -e "${BLUE}ðŸ“¡ Sending SSH Key to Primary Server...${NC}"
    sshpass -p "$SERVER_PASS" ssh-copy-id -o StrictHostKeyChecking=no -p ${SSH_PORT} root@${PRIMARY_IP}

    # ================= TWO_IP SCRIPT =================
    echo -e "${BLUE}ðŸ“ Creating Tunnel Script...${NC}"
    sudo bash -c "cat > /usr/local/bin/two_ip" <<EOF
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"

connect_ssh() {
    IP=\$1
    echo "Trying \$IP ..."
    
    /usr/bin/ssh \\
    -o ConnectTimeout=10 \\
    -o ServerAliveInterval=10 \\
    -o ServerAliveCountMax=2 \\
    -o TCPKeepAlive=no \\
    -o ExitOnForwardFailure=yes \\
    -N -L 0.0.0.0:\${PORT_LOCAL}:127.0.0.1:\${PORT_REMOTE} \\
    -p \${SSH_PORT} root@\${IP}
}

while true; do

    if [ -f "\$CONFIG_FILE" ]; then
        source "\$CONFIG_FILE"
    else
        echo "Config file \$CONFIG_FILE not found!"
        sleep 10
        continue
    fi

    RETRY=0
    while [ \$RETRY -lt \$MAX_RETRY ]; do
        connect_ssh \$PRIMARY_IP
        RETRY=\$((RETRY+1))
        echo "Primary failed. Retry \$RETRY"
        sleep 2
    done

    echo "Switching to SECONDARY IP..."
    connect_ssh \$SECONDARY_IP

    echo "Secondary disconnected. Restarting cycle..."
    sleep 2
done
EOF

    sudo chmod +x /usr/local/bin/two_ip
    echo -e "${GREEN}âœ” Tunnel Script Created${NC}"

    # ================= CONFIG FILE =================
    echo -e "${BLUE}ðŸ“„ Creating Config File...${NC}"
    sudo bash -c "cat > /etc/two_ip.conf" <<EOF
PRIMARY_IP="${PRIMARY_IP}"
SECONDARY_IP="${SECONDARY_IP}"
PORT_LOCAL="${PORT_LOCAL}"
PORT_REMOTE="${PORT_REMOTE}"
SSH_PORT="${SSH_PORT}"
MAX_RETRY=3
EOF

    sudo chmod 600 /etc/two_ip.conf
    sudo chown root:root /etc/two_ip.conf
    echo -e "${GREEN}âœ” Config File Created${NC}"

    # ================= SERVICE =================
    echo -e "${BLUE}ðŸ”§ Creating systemd Service...${NC}"
    sudo bash -c "cat > /etc/systemd/system/autossh-iran.service" <<EOF
[Unit]
Description=SSH Tunnel Iran Two IP Failover
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/two_ip
Restart=always
RestartSec=3
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable autossh-iran >/dev/null 2>&1
    sudo systemctl restart autossh-iran

    echo -e "${GREEN}âœ” Installation Completed! Tunnel Service Running${NC}"
}

restart_tunnel() {
    echo -e "${BLUE}ðŸ”„ Restarting SSH Tunnel...${NC}"
    sudo systemctl restart autossh-iran
    echo -e "${GREEN}âœ” Tunnel Restarted${NC}"
}

# ================= MENU =================
while true; do
    echo ""
    echo -e "${YELLOW}================ Menu ================${NC}"
    echo -e "${BLUE}1.${NC} Installation"
    echo -e "${CYAN}2.${NC} Restart SSH-Tunnel"
    echo -e "${GREEN}3.${NC} Exit"
    read -p "Choose an option: " CHOICE

    case \$CHOICE in
        1) install_script ;;
        2) restart_tunnel ;;
        3) echo -e "${GREEN}ðŸ‘‹ Exiting...${NC}"; exit 0 ;;
        *) echo -e "${RED}Invalid option. Try again.${NC}" ;;
    esac
done
