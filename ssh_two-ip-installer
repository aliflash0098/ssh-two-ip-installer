#!/bin/bash

clear

echo "=============================================="
echo "        Two IP Tunnel Auto Installer"
echo "=============================================="
echo ""

# Update server
apt update -y && apt upgrade -y

# install requirements
apt install -y sshpass

echo ""
echo "--------- تنظیمات سرور خارج ---------"

read -p "IP PRIMARY خارج: " PRIMARY_IP
read -p "IP SECONDARY خارج: " SECONDARY_IP
read -p "SSH PORT خارج: " SSH_PORT
read -p "LOCAL PORT خارج: " PORT_LOCAL
read -p "REMOTE PORT خارج: " PORT_REMOTE
read -p "PASSWORD سرور خارج: " PASSWORD

SSH_PORT=${SSH_PORT:-3000}
PORT_LOCAL=${PORT_LOCAL:-42974}
PORT_REMOTE=${PORT_REMOTE:-42974}

echo ""
echo "Generating SSH Key..."

yes "" | ssh-keygen -t rsa -b 4096

echo ""
echo "Copy SSH Key To Server..."

sshpass -p "$PASSWORD" ssh-copy-id -p $SSH_PORT -o StrictHostKeyChecking=no root@$PRIMARY_IP

########################################
# sshd config
########################################

cat >> /etc/ssh/sshd_config <<EOF

port 3000
ClientAliveInterval 60
ClientAliveCountMax 3
TCPKeepAlive yes
EOF

########################################
# limits
########################################

cat >> /etc/security/limits.conf <<EOF

* soft nofile 1048576
* hard nofile 1048576
root soft nofile 1048576
root hard nofile 1048576
EOF

########################################
# systemd limits
########################################

echo "DefaultLimitNOFILE=1048576" >> /etc/systemd/system.conf
echo "DefaultLimitNOFILE=1048576" >> /etc/systemd/user.conf

mkdir -p /etc/systemd/system/ssh.service.d

cat > /etc/systemd/system/ssh.service.d/override.conf <<EOF
[Service]
LimitNOFILE=1048576
EOF

########################################
# two_ip script
########################################

cat > /usr/local/bin/two_ip <<EOF
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"

connect_ssh() {
    IP=\$1
    echo "Trying \$IP ..."
    
    /usr/bin/ssh \
    -o ConnectTimeout=10 \
    -o ServerAliveInterval=10 \
    -o ServerAliveCountMax=2 \
    -o TCPKeepAlive=no \
    -o ExitOnForwardFailure=yes \
    -N -L 0.0.0.0:\${PORT_LOCAL}:127.0.0.1:\${PORT_REMOTE} \
    -p \${SSH_PORT} root@\${IP}
}

while true; do

    if [ -f "\$CONFIG_FILE" ]; then
        source "\$CONFIG_FILE"
    else
        echo "Config file not found!"
        sleep 10
        continue
    fi

    RETRY=0
    while [ \$RETRY -lt \$MAX_RETRY ]; do
        connect_ssh \$PRIMARY_IP
        RETRY=\$((RETRY+1))
        sleep 2
    done

    connect_ssh \$SECONDARY_IP
    sleep 2
done
EOF

chmod +x /usr/local/bin/two_ip

########################################
# config file
########################################

cat > /etc/two_ip.conf <<EOF
PRIMARY_IP="$PRIMARY_IP"
SECONDARY_IP="$SECONDARY_IP"
PORT_LOCAL="$PORT_LOCAL"
PORT_REMOTE="$PORT_REMOTE"
SSH_PORT="$SSH_PORT"
MAX_RETRY=2
EOF

########################################
# service
########################################

cat > /etc/systemd/system/autossh-iran.service <<EOF
[Unit]
Description=SSH Tunnel Iran Two IP Failover
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/two_ip
Restart=always
RestartSec=3
TimeoutStopSec=5
KillMode=mixed
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

########################################
# setup script
########################################

cat > /usr/local/bin/setup-two-ip.sh <<EOF
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"

clear

echo "Two IP Config Setup"

read -p "PRIMARY IP: " PRIMARY_IP
read -p "SECONDARY IP: " SECONDARY_IP
read -p "SSH PORT: " SSH_PORT
read -p "LOCAL PORT: " PORT_LOCAL
read -p "REMOTE PORT: " PORT_REMOTE

SSH_PORT=\${SSH_PORT:-3000}
PORT_LOCAL=\${PORT_LOCAL:-42974}
PORT_REMOTE=\${PORT_REMOTE:-42974}

cat > \$CONFIG_FILE <<EOL
PRIMARY_IP="\$PRIMARY_IP"
SECONDARY_IP="\$SECONDARY_IP"
PORT_LOCAL="\$PORT_LOCAL"
PORT_REMOTE="\$PORT_REMOTE"
SSH_PORT="\$SSH_PORT"
MAX_RETRY=2
EOL

echo "Done"
EOF

chmod +x /usr/local/bin/setup-two-ip.sh

########################################
# restart services
########################################

systemctl daemon-reload
systemctl daemon-reexec
systemctl restart ssh
systemctl enable autossh-iran
systemctl start autossh-iran
systemctl restart autossh-iran

echo ""
echo "====================================="
echo "Install Completed"
echo "====================================="
