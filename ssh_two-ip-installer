#!/bin/bash

# ================= COLORS =================
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
NC='\033[0m'

clear

echo -e "${CYAN}==============================================${NC}"
echo -e "${GREEN}        SSH Two IP Auto Installer${NC}"
echo -e "${CYAN}==============================================${NC}"
echo ""

# ================= INPUT =================
echo -ne "${YELLOW}Enter PRIMARY IP: ${NC}"
read PRIMARY_IP

echo -ne "${YELLOW}Enter SECONDARY IP: ${NC}"
read SECONDARY_IP

echo -ne "${YELLOW}Enter SSH PORT: ${NC}"
read SSH_PORT

echo -ne "${YELLOW}Enter LOCAL PORT: ${NC}"
read PORT_LOCAL

echo -ne "${YELLOW}Enter REMOTE PORT: ${NC}"
read PORT_REMOTE

echo -ne "${YELLOW}Enter OUTSIDE SERVER ROOT PASSWORD: ${NC}"
read -s SERVER_PASS
echo ""

echo -e "${BLUE}Configuring SSH keepalive...${NC}"

# ================= SSH CONFIG =================
cat >> /etc/ssh/sshd_config <<EOF

ClientAliveInterval 60
ClientAliveCountMax 3
TCPKeepAlive yes
EOF

systemctl restart ssh

# ================= SYSTEM LIMIT =================
echo -e "${BLUE}Setting system limits...${NC}"

echo "DefaultLimitNOFILE=1048576" >> /etc/systemd/system.conf
echo "DefaultLimitNOFILE=1048576" >> /etc/systemd/user.conf

mkdir -p /etc/systemd/system/ssh.service.d

cat > /etc/systemd/system/ssh.service.d/override.conf <<EOF
[Service]
LimitNOFILE=1048576
EOF

# ================= SSH KEY =================
echo -e "${BLUE}Generating SSH key...${NC}"
yes "" | ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa

echo -e "${BLUE}Copying SSH key to primary server...${NC}"

apt install -y sshpass >/dev/null 2>&1

sshpass -p "$SERVER_PASS" ssh-copy-id -o StrictHostKeyChecking=no -p ${SSH_PORT} root@${PRIMARY_IP}

# ================= TWO_IP SCRIPT =================
echo -e "${BLUE}Creating tunnel script...${NC}"

cat > /usr/local/bin/two_ip <<EOF
#!/bin/bash

CONFIG_FILE="/etc/two_ip.conf"

connect_ssh() {
    IP=\$1
    echo "Trying \$IP ..."
    
    /usr/bin/ssh \\
    -o ConnectTimeout=10 \\
    -o ServerAliveInterval=10 \\
    -o ServerAliveCountMax=2 \\
    -o TCPKeepAlive=no \\
    -o ExitOnForwardFailure=yes \\
    -N -L 0.0.0.0:${PORT_LOCAL}:127.0.0.1:${PORT_REMOTE} \\
    -p ${SSH_PORT} root@\${IP}
}

while true; do
    if [ -f "\$CONFIG_FILE" ]; then
        source "\$CONFIG_FILE"
    else
        echo "Config file not found!"
        sleep 10
        continue
    fi

    connect_ssh \$PRIMARY_IP || connect_ssh \$SECONDARY_IP
    echo "Tunnel disconnected. Restarting..."
    sleep 2
done
EOF

chmod +x /usr/local/bin/two_ip

# ================= CONFIG FILE =================
echo -e "${BLUE}Creating config file...${NC}"

cat > /etc/two_ip.conf <<EOF
PRIMARY_IP="${PRIMARY_IP}"
SECONDARY_IP="${SECONDARY_IP}"
PORT_LOCAL="${PORT_LOCAL}"
PORT_REMOTE="${PORT_REMOTE}"
SSH_PORT="${SSH_PORT}"
MAX_RETRY=2
EOF

chmod 600 /etc/two_ip.conf
chown root:root /etc/two_ip.conf

# ================= SERVICE =================
echo -e "${BLUE}Creating systemd service...${NC}"

cat > /etc/systemd/system/autossh-iran.service <<EOF
[Unit]
Description=SSH Tunnel Iran Two IP Failover
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/two_ip
Restart=always
RestartSec=3
TimeoutStopSec=5
KillMode=mixed
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reexec
systemctl daemon-reload
systemctl enable autossh-iran
systemctl start autossh-iran

# ================= DONE =================
echo ""
echo -e "${GREEN}==============================================${NC}"
echo -e "${GREEN}✔ Installation Completed Successfully${NC}"
echo -e "${GREEN}✔ SSH KeepAlive Configured${NC}"
echo -e "${GREEN}✔ System Limits Increased${NC}"
echo -e "${GREEN}✔ SSH Key Installed${NC}"
echo -e "${GREEN}✔ Tunnel Service Running${NC}"
echo -e "${GREEN}==============================================${NC}"
echo -e "${CYAN}Check status: systemctl status autossh-iran${NC}"

Commit changes
